"use strict";var e=require("@zippybee/nng"),t=require("./proto/wcf.js"),s=require("./utils.js"),n=require("./file-ref.js"),c=require("./message.js"),r=require("./proto/extrabyte.js"),o=require("./proto/roomdata.js"),i=require("path"),a=require("os");function u(e){return"string"==typeof e||Buffer.isBuffer(e)?new n.FileRef(e):"save"in e?e:new n.FileRef(Buffer.from(e.data))}function f(e,t){switch(e){case 1:return Number.parseInt(s.uint8Array2str(t),10);case 2:return Number.parseFloat(s.uint8Array2str(t));case 3:default:return s.uint8Array2str(t);case 4:return Buffer.from(t);case 5:return}}exports.wcferry=class{cmdsocket;msgsocket;storedCallback;option;NotFriend={fmessage:"朋友推荐消息",medianote:"语音记事本",floatbottle:"漂流瓶",filehelper:"文件传输助手",newsapp:"新闻"};constructor(e){this.cmdsocket=null,this.msgsocket=null,this.storedCallback=e=>e,this.option={...e,cacheDir:e.cacheDir||s.createTmpDir()},s.ensureDirSync(this.option.cacheDir)}trapOnExit(){process.on("exit",this.stop)}stop(){this.cmdsocket?.close(),this.msgsocket?.close(),this.cmdsocket=null,this.msgsocket=null,console.log("stop")}start(){this.cmdsocket=new e.SocketWrapper,this.cmdsocket.connect(1,`tcp://${this.option.host}`,5e3,5e3),console.log(`Connected to CMD server at ${this.option.host}`),this.trapOnExit()}createMsgSocket(s){const[n,r]=this.option.host.split(":");this.msgsocket=new e.SocketWrapper;const o=`${n}:${+r+1}`;this.msgsocket.connect(1,`tcp://${o}`,0,0),console.log(`Connected to Msg server at ${o}`),this.msgsocket.recv(((e,n)=>{e&&console.log("error while receiving message: %O",e);const r=t.wcf.Response.deserialize(n);s(new c.Message(r.wxmsg))}))}listening(e){if("function"!=typeof e)throw new Error("callback must be a function");const s=new t.wcf.Request({func:t.wcf.Functions.FUNC_ENABLE_RECV_TXT,flag:this.option.recvPyq});if(0!==this.sendCmdMessage(s).status)throw new Error("enable recv txt failed");this.storedCallback=e,this.createMsgSocket(e)}stopListening(){if(!this.msgsocket)return;const e=new t.wcf.Request({func:t.wcf.Functions.FUNC_DISABLE_RECV_TXT}),s=this.sendCmdMessage(e);return this.msgsocket.close(),this.msgsocket=null,s.status}sendCmdMessage(e){if(!this.cmdsocket)throw new Error("cmdsocket is not connected");const s=e.serialize(),n=this.cmdsocket.send(Buffer.from(s));return t.wcf.Response.deserialize(n)}setRecvPyq(e){if(this.option.recvPyq!==e){if(!this.msgsocket)return"未开启监听";this.option.recvPyq=e,this.stopListening(),this.listening(this.storedCallback)}}isLogin(){const e=new t.wcf.Request({func:t.wcf.Functions.FUNC_IS_LOGIN});return 1==this.sendCmdMessage(e).status}getSelfWxid(){const e=new t.wcf.Request({func:t.wcf.Functions.FUNC_GET_SELF_WXID});return this.sendCmdMessage(e).str}getUserInfo(){const e=new t.wcf.Request({func:t.wcf.Functions.FUNC_GET_USER_INFO});return this.sendCmdMessage(e).ui}getContacts(){const e=new t.wcf.Request({func:t.wcf.Functions.FUNC_GET_CONTACTS});return this.sendCmdMessage(e).contacts.contacts.map((e=>e.toObject()))}getContact(e){const s=new t.wcf.Request({func:t.wcf.Functions.FUNC_GET_CONTACT_INFO,str:e});return this.sendCmdMessage(s).contacts.contacts[0].toObject()}getDbNames(){const e=new t.wcf.Request({func:t.wcf.Functions.FUNC_GET_DB_NAMES});return this.sendCmdMessage(e).dbs.names}getDbTables(e){const s=new t.wcf.Request({func:t.wcf.Functions.FUNC_GET_DB_TABLES,str:e});return this.sendCmdMessage(s).tables.tables.map((e=>e.toObject()))}dbSqlQuery(e,s){const n=new t.wcf.Request({func:t.wcf.Functions.FUNC_EXEC_DB_QUERY,query:new t.wcf.DbQuery({db:e,sql:s})});return this.sendCmdMessage(n).rows.rows.map((e=>Object.fromEntries(e.fields.map((e=>[e.column,f(e.type,e.content)])))))}getMsgTypes(){const e=new t.wcf.Request({func:t.wcf.Functions.FUNC_GET_MSG_TYPES});return this.sendCmdMessage(e).types.types.map((e=>e.toObject()))}refreshPyq(e){const s=new t.wcf.Request({func:t.wcf.Functions.FUNC_REFRESH_PYQ,ui64:e});return this.sendCmdMessage(s).status}getChatRooms(){return this.getContacts().filter((e=>e.wxid.endsWith("@chatroom")))}getFriends(){return this.getContacts().filter((e=>!e.wxid.endsWith("@chatroom")&&!e.wxid.startsWith("gh_")&&!Object.hasOwn(this.NotFriend,e.wxid)))}async getChatRoomMembers(e,t=5){if(0===t)return{};const[n]=this.dbSqlQuery("MicroMsg.db",`SELECT RoomData FROM ChatRoom WHERE ChatRoomName = '${e}';`);if(!n)return await s.sleep(),this.getChatRoomMembers(e,t-1)??{};const c=o.com.iamteer.wcf.RoomData.deserialize(n.RoomData),r=this.dbSqlQuery("MicroMsg.db","SELECT UserName, NickName FROM Contact;"),i=Object.fromEntries(r.map((e=>[e.UserName,e.NickName])));return Object.fromEntries(c.members.map((e=>[e.wxid,e.name||i[e.wxid]])))}getAliasInChatRoom(e,t){const[s]=this.dbSqlQuery("MicroMsg.db",`SELECT RoomData FROM ChatRoom WHERE ChatRoomName = '${t}';`);if(!s)return;const n=o.com.iamteer.wcf.RoomData.deserialize(s.RoomData);return n.members.find((t=>t.wxid===e))?.name||this.getNickName(e)?.[0]}getNickName(...e){return this.dbSqlQuery("MicroMsg.db",`SELECT NickName FROM Contact WHERE UserName in (${e.map((e=>`'${e}'`)).join(",")});`).map((e=>e.NickName))}inviteChatroomMembers(e,s){const n=new t.wcf.Request({func:t.wcf.Functions.FUNC_INV_ROOM_MEMBERS,m:new t.wcf.MemberMgmt({roomid:e,wxids:s.join(",").replaceAll(" ","")})});return this.sendCmdMessage(n).status}addChatRoomMembers(e,s){const n=new t.wcf.Request({func:t.wcf.Functions.FUNC_ADD_ROOM_MEMBERS,m:new t.wcf.MemberMgmt({roomid:e,wxids:s.join(",").replaceAll(" ","")})});return this.sendCmdMessage(n).status}delChatRoomMembers(e,s){const n=new t.wcf.Request({func:t.wcf.Functions.FUNC_DEL_ROOM_MEMBERS,m:new t.wcf.MemberMgmt({roomid:e,wxids:s.join(",").replaceAll(" ","")})});return this.sendCmdMessage(n).status}revokeMsg(e){const s=new t.wcf.Request({func:t.wcf.Functions.FUNC_REVOKE_MSG,ui64:e});return this.sendCmdMessage(s).status}forwardMsg(e,s){const n=new t.wcf.Request({func:t.wcf.Functions.FUNC_FORWARD_MSG,fm:new t.wcf.ForwardMsg({id:e,receiver:s})});return this.sendCmdMessage(n).status}sendTxt(e,s,n){const c=new t.wcf.Request({func:t.wcf.Functions.FUNC_SEND_TXT,txt:new t.wcf.TextMsg({msg:e,receiver:s,aters:n})});return this.sendCmdMessage(c).status}async sendImage(e,s){const n=u(e),{path:c,discard:r}=await n.save(this.option.cacheDir),o=new t.wcf.Request({func:t.wcf.Functions.FUNC_SEND_IMG,file:new t.wcf.PathMsg({path:c,receiver:s})}),i=this.sendCmdMessage(o);return r(),i.status}async sendFile(e,s){const n=u(e),{path:c,discard:r}=await n.save(this.option.cacheDir),o=new t.wcf.Request({func:t.wcf.Functions.FUNC_SEND_FILE,file:new t.wcf.PathMsg({path:c,receiver:s})}),i=this.sendCmdMessage(o);return r(),i.status}sendXML(e,s){const n=new t.wcf.Request({func:t.wcf.Functions.FUNC_SEND_XML,xml:new t.wcf.XmlMsg({receiver:s,content:e.content,type:e.type,path:e.path})});return this.sendCmdMessage(n).status}sendEmotion(e,s){const n=new t.wcf.Request({func:t.wcf.Functions.FUNC_SEND_EMOTION,file:new t.wcf.PathMsg({path:e,receiver:s})});return this.sendCmdMessage(n).status}sendRichText(e,s){const n=new t.wcf.Request({func:t.wcf.Functions.FUNC_SEND_RICH_TXT,rt:new t.wcf.RichText({...e,receiver:s})});return this.sendCmdMessage(n).status}async getAudioMsg(e,n,c=3){const r=new t.wcf.Request({func:t.wcf.Functions.FUNC_GET_AUDIO_MSG,am:new t.wcf.AudioMsg({id:e,dir:n})}),o=this.sendCmdMessage(r);if(o.str)return o.str;if(c>0)return await s.sleep(),this.getAudioMsg(e,n,c-1);throw new Error("Timeout: get audio msg")}async getOCRResult(e,n=2){const c=new t.wcf.Request({func:t.wcf.Functions.FUNC_EXEC_OCR,str:e}),r=this.sendCmdMessage(c);if(0===r.ocr.status&&r.ocr.result)return r.ocr.result;if(n>0)return await s.sleep(),this.getOCRResult(e,n-1);throw new Error("Timeout: get ocr result")}downloadAttach(e,s="",n=""){const c=new t.wcf.Request({func:t.wcf.Functions.FUNC_DOWNLOAD_ATTACH,att:new t.wcf.AttachMsg({id:e,thumb:s,extra:n})});return this.sendCmdMessage(c).status}UserDir=i.join(a.homedir(),"Documents","WeChat Files");getMsgAttachments(e){const t=this.dbSqlQuery("MSG0.db",`Select * from MSG WHERE MsgSvrID = "${e}"`),s=t?.[0]?.BytesExtra;if(!Buffer.isBuffer(s))return{};const n=r.com.iamteer.wcf.Extra.deserialize(s),{properties:c}=n.toObject();if(!c)return{};const o=Object.fromEntries(c.map((e=>[e.type,e.value]))),a=o[r.com.iamteer.wcf.Extra.PropertyKey.Extra],u=o[r.com.iamteer.wcf.Extra.PropertyKey.Thumb];return{extra:a?i.resolve(this.UserDir,a):"",thumb:u?i.resolve(this.UserDir,u):""}}decryptImage(e,s){const n=new t.wcf.Request({func:t.wcf.Functions.FUNC_DECRYPT_IMAGE,dec:new t.wcf.DecPath({src:e,dst:s})});return this.sendCmdMessage(n).str}async downloadImage(e,t,n,c,r=30){const o=n?{extra:n,thumb:c}:this.getMsgAttachments(e);if(0!==this.downloadAttach(e,o.thumb,o.extra))return Promise.reject("Failed to download attach");for(let e=0;e<r;e++){const e=this.decryptImage(o.extra||"",t);if(e)return e;await s.sleep()}return Promise.reject("Failed to decrypt image")}acceptNewFriend(e,s,n=30){const c=new t.wcf.Request({func:t.wcf.Functions.FUNC_ACCEPT_FRIEND,v:new t.wcf.Verification({v3:e,v4:s,scene:n})});return this.sendCmdMessage(c).status}receiveTransfer(e,s,n){const c=new t.wcf.Request({func:t.wcf.Functions.FUNC_RECV_TRANSFER,tf:new t.wcf.Transfer({wxid:e,tfid:s,taid:n})});return this.sendCmdMessage(c).status}};
